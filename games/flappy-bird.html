<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Bird</title>
<style>
body {background:black;color:white;font-family:Arial;text-align:center;margin:0;overflow:hidden;}
#game-wrapper {position:relative;width:400px;margin:50px auto;}
canvas {background:#87CEEB;display:block;margin:20px auto;border:2px solid #00ffcc;border-radius:10px;}
button{padding:10px 20px;font-size:16px;cursor:pointer;margin-top:10px;}
#close-btn{position:absolute;top:10px;left:10px;}
#game-over{display:none;}
</style>
</head>
<body>
<div id="game-wrapper">
  <button id="close-btn" onclick="window.parent.postMessage('closeGame','*')">❌</button>
  <h1>Flappy Bird</h1>
  <button id="start-btn">Start</button>
  <canvas id="flappy-canvas" width="400" height="600"></canvas>
  <div id="game-over">
    <h2>Game Over</h2>
    <button id="restart-btn">Recommencer</button>
  </div>
</div>

<script>
const canvas=document.getElementById("flappy-canvas");
const ctx=canvas.getContext("2d");
const startBtn=document.getElementById("start-btn");
const restartBtn=document.getElementById("restart-btn");
const gameOverDiv=document.getElementById("game-over");

let bird, pipes, score, gameInterval;
const gravity=0.6;
let lift=-6; // moitié de l'ancien lift
let pipeSpeed=2;
const pipeGapBase=150;
let pipeGap=pipeGapBase;

let speedMultiplier=1;
const maxMultiplier=2;
const multiplierIncrease=0.0005; // augmentation progressive

function resetGame() {
  bird={x:50,y:300,radius:15,velocity:0};
  pipes=[];
  score=0;
  speedMultiplier=1;
  pipeGap=pipeGapBase*1.5; // 1.5 fois plus grand
  gameOverDiv.style.display="none";
  startBtn.style.display="none";
}

function startGame(){
  resetGame();
  gameInterval=setInterval(update,20);
}

function endGame(){
  clearInterval(gameInterval);
  gameOverDiv.style.display="block";
}

document.addEventListener("keydown", e=>{
  if(e.key===" " || e.key.toLowerCase()==="w") bird.velocity=lift;
});

restartBtn.addEventListener("click", startGame);
startBtn.addEventListener("click", startGame);

function update(){
  // augmenter progressivement la vitesse
  if(speedMultiplier < maxMultiplier) speedMultiplier += multiplierIncrease;

  bird.velocity += gravity;
  bird.y += bird.velocity;

  // add pipes
  if(pipes.length===0 || pipes[pipes.length-1].x < 200){
    let topHeight=Math.random()*(canvas.height-pipeGap-100)+50;
    pipes.push({x:canvas.width, top:topHeight});
  }

  // move pipes and check collision
  for(let i=pipes.length-1;i>=0;i--){
    pipes[i].x -= pipeSpeed*speedMultiplier;

    if(bird.x + bird.radius > pipes[i].x &&
       bird.x - bird.radius < pipes[i].x + 50 &&
       (bird.y - bird.radius < pipes[i].top || bird.y + bird.radius > pipes[i].top + pipeGap)){
      endGame();
    }

    if(pipes[i].x + 50 < 0) {
      pipes.splice(i,1);
      score++;
    }
  }

  // check top/bottom
  if(bird.y + bird.radius > canvas.height || bird.y - bird.radius < 0) endGame();

  draw();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // draw bird
  ctx.fillStyle="yellow";
  ctx.beginPath();
  ctx.arc(bird.x,bird.y,bird.radius,0,Math.PI*2);
  ctx.fill();

  // draw pipes
  ctx.fillStyle="green";
  pipes.forEach(pipe=>{
    ctx.fillRect(pipe.x,0,50,pipe.top);
    ctx.fillRect(pipe.x,pipe.top+pipeGap,50,canvas.height-(pipe.top+pipeGap));
  });

  // draw score
  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.fillText("Score: "+score,10,30);
}
</script>
</body>
</html>
