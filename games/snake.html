const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const tileSize = 32;
const tileset = new Image();
tileset.src = "snake-assets/tileset.png"; // place ton PNG ici

const width = canvas.width / tileSize;
const height = canvas.height / tileSize;

let snake = [{x: 10, y: 10}];
let direction = "RIGHT";
let nextDirection = "RIGHT";
let food = spawnFood();
let gameInterval;

document.addEventListener("keydown", e => {
  if (e.key === "ArrowUp" || e.key === "z") if (direction !== "DOWN") nextDirection = "UP";
  if (e.key === "ArrowDown" || e.key === "s") if (direction !== "UP") nextDirection = "DOWN";
  if (e.key === "ArrowLeft" || e.key === "q") if (direction !== "RIGHT") nextDirection = "LEFT";
  if (e.key === "ArrowRight" || e.key === "d") if (direction !== "LEFT") nextDirection = "RIGHT";
});

tileset.onload = () => {
  gameInterval = setInterval(update, 150);
};

function spawnFood() {
  let x = Math.floor(Math.random() * width);
  let y = Math.floor(Math.random() * height);
  // Ã©vite la nourriture sur le snake
  while (snake.some(s => s.x === x && s.y === y)) {
    x = Math.floor(Math.random() * width);
    y = Math.floor(Math.random() * height);
  }
  return {x, y};
}

function update() {
  direction = nextDirection;
  let head = {...snake[0]};

  if (direction === "UP") head.y--;
  if (direction === "DOWN") head.y++;
  if (direction === "LEFT") head.x--;
  if (direction === "RIGHT") head.x++;

  // collision murs
  if (head.x < 0 || head.x >= width || head.y < 0 || head.y >= height) return gameOver();
  // collision snake
  if (snake.some(s => s.x === head.x && s.y === head.y)) return gameOver();

  snake.unshift(head);

  // manger la nourriture
  if (head.x === food.x && head.y === food.y) {
    food = spawnFood();
  } else {
    snake.pop();
  }

  draw();
}

function gameOver() {
  clearInterval(gameInterval);
  alert("ðŸ’¥ Game Over!");
  snake = [{x: 10, y: 10}];
  direction = "RIGHT";
  nextDirection = "RIGHT";
  food = spawnFood();
  gameInterval = setInterval(update, 150);
}

function draw() {
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // dessiner nourriture
  ctx.drawImage(
    tileset,
    tileSize*8, 0, tileSize, tileSize, // nourriture
    food.x*tileSize, food.y*tileSize, tileSize, tileSize
  );

  // dessiner snake
  snake.forEach((segment, i) => {
    let sx = 0, sy = 0;

    if (i === 0) { // tÃªte
      if (direction === "UP") sx = tileSize*0;
      if (direction === "DOWN") sx = tileSize*1;
      if (direction === "LEFT") sx = tileSize*2;
      if (direction === "RIGHT") sx = tileSize*3;
    } else if (i === snake.length-1) { // queue
      sx = tileSize*7;
    } else { // corps
      if (snake[i-1].x === segment.x) sx = tileSize*4; // vertical
      else sx = tileSize*5; // horizontal
    }

    ctx.drawImage(
      tileset,
      sx, sy, tileSize, tileSize,
      segment.x*tileSize, segment.y*tileSize, tileSize, tileSize
    );
  });
}
